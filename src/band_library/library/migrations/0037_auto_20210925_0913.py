# Generated by Django 2.2.23 on 2021-09-24 23:13

from django.db import migrations, models

def copy_media(apps, schema_editor):
    Entry = apps.get_model("library", "Entry")
    EntryMedia = apps.get_model("library", "EntryMedia")
    EntryPurpose = apps.get_model("library", "EntryPurpose")
    LibraryPersona = apps.get_model("library", "LibraryPersona")
    everyone,_ = LibraryPersona.objects.get_or_create(label="everyone")
    defpurpose,_ = EntryPurpose.objects.get_or_create(label="promotional")
    for entry in Entry.objects.filter(media__isnull=False):
        newmedia, _ = EntryMedia.objects.get_or_create(
            entry=entry,
            mfile=entry.media,
            pagecount=entry.pagecount,
            asthumb=True,
            purpose=defpurpose,
            visibility=everyone,
            comment="copied from media"
        )
        
def init_data(apps, schema_editor):
    EntryPurpose = apps.get_model("library", "EntryPurpose")
    LibraryPersona = apps.get_model("library", "LibraryPersona")
    admin,_ = LibraryPersona.objects.get_or_create(label="admin")
    everyone,_ = LibraryPersona.objects.get_or_create(label="everyone")
    defpurpose,_ = EntryPurpose.objects.get_or_create(label="promotional")

class Migration(migrations.Migration):

    dependencies = [
        ('library', '0036_auto_20210925_0829'),
    ]

    operations = [
        migrations.RunPython(init_data),
        migrations.AddField(
            model_name='entrymedia',
            name='comment',
            field=models.CharField(blank=True, max_length=128, null=True),
        ),
        migrations.AddField(
            model_name='entrymedia',
            name='pagecount',
            field=models.IntegerField(blank=True, null=True, verbose_name='Page count'),
        ),
        migrations.RunPython(copy_media)
    ]
